@using PermissionSystemWeb.Models.ViewModels
@model BulkUploadVm

@{
    ViewData["Title"] = "Bulk Upload";
}

<link rel="stylesheet" href="~/css/bulkupload.css" />

<div class="page-header">
    <h1 class="page-title">
        <i class="bi bi-cloud-upload-fill" style="color: #3b82f6;"></i>
        Bulk Upload Requests
    </h1>
    <p class="page-subtitle">Upload multiple permission requests using an Excel file</p>
</div>

<div class="info-banner">
    <div class="info-banner-content">
        <div class="info-icon">
            <i class="bi bi-lightbulb"></i>
        </div>
        <div class="info-text">
            <h4>How to use Bulk Upload</h4>
            <p>Download the Excel template, fill in your data, select the system, and upload the file. Maximum file size is 5MB.</p>
        </div>
    </div>
</div>

<a href="@Url.Action("DownloadTemplate", "BulkUpload")"
   class="btn-template" target="_blank">
    <i class="bi bi-file-earmark-excel"></i>
    Download Excel Template
</a>

@if (TempData["Error"] != null)
{
    <div class="alert-modern danger">
        <i class="bi bi-exclamation-triangle"></i>
        <strong>Error:</strong> @TempData["Error"]
    </div>
}

@if (TempData["Success"] != null || TempData["Failed"] != null)
{
    <div class="summary-card">
        <h3 class="summary-title">
            <i class="bi bi-graph-up"></i>
            Upload Summary
        </h3>

        <div class="summary-stats">
            <div class="stat-item success">
                <div class="stat-label">Success</div>
                <div class="stat-value">@TempData["Success"]</div>
            </div>

            <div class="stat-item failed">
                <div class="stat-label">Failed</div>
                <div class="stat-value">@TempData["Failed"]</div>
            </div>

            @if (TempData["Total"] != null)
            {
                <div class="stat-item total">
                    <div class="stat-label">Total</div>
                    <div class="stat-value">@TempData["Total"]</div>
                </div>
            }
        </div>

        @if (TempData["Errors"] is List<string> errors && errors.Count > 0)
        {
            <div class="alert-modern danger">
                <i class="bi bi-exclamation-circle"></i>
                <strong>Errors Found:</strong>
                <ul class="errors-list">
                    @foreach (var err in errors)
                    {
                        <li>@err</li>
                    }
                </ul>
            </div>
        }

        @if (TempData["DetailedErrors"] is List<BulkErrorVm> detailedErrors && detailedErrors.Count > 0)
        {
            <div class="alert-modern danger">
                <i class="bi bi-list-check"></i>
                <strong>Detailed Errors:</strong>
                <div class="error-details">
                    @foreach (var error in detailedErrors)
                    {
                        <div class="error-item">
                            <div class="error-header">
                                <span class="error-row">Row @error.RowNumber</span>
                                @if (!string.IsNullOrEmpty(error.FieldName))
                                {
                                    <span class="error-field">Field: @error.FieldName</span>
                                }
                            </div>
                            <div class="error-message">@error.Message</div>
                        </div>
                    }
                </div>
            </div>
        }
        else if (TempData["Success"] != null && (int)TempData["Success"] > 0)
        {
            <div class="alert-modern success">
                <i class="bi bi-check-circle-fill"></i>
                <strong>Success!</strong> All rows processed successfully.
            </div>
        }

        @if (TempData["BatchId"] != null)
        {
            <div class="alert-modern info">
                <i class="bi bi-info-circle"></i>
                <strong>Batch ID:</strong> @TempData["BatchId"] - You can track this upload in the requests list.
            </div>
        }
    </div>
}

<form method="post" enctype="multipart/form-data" id="uploadForm" asp-action="Upload">
    @Html.AntiForgeryToken()

    <div class="upload-card">
        <h3 class="form-section-title">
            <i class="bi bi-upload"></i>
            Upload Configuration
        </h3>

        <div class="form-group-modern">
            <label class="form-label-modern">
                <i class="bi bi-gear"></i>
                Select System Type
            </label>
            <select asp-for="SystemType" class="form-control-modern" id="SystemType" required>
                <option value="">-- Choose a system type --</option>
                <option value="InvoiceQ">InvoiceQ</option>
                <option value="Ocity">Ocity</option>
            </select>
            <span asp-validation-for="SystemType" class="validation-error"></span>
            <small class="form-hint">Select the system type that matches the Excel tab you filled</small>
        </div>

        <div class="form-group-modern">
            <label class="form-label-modern">
                <i class="bi bi-file-earmark-excel"></i>
                Excel File
            </label>
            <div class="file-upload-area" id="fileUploadArea">
                <div class="file-icon">
                    <i class="bi bi-file-earmark-arrow-up"></i>
                </div>
                <div class="file-upload-text">
                    <h5>Click to browse or drag and drop</h5>
                    <p>Supported formats: .xlsx, .xls (Max 5MB)</p>
                </div>
                <input type="file" asp-for="ExcelFile" class="file-input-hidden" id="ExcelFile" accept=".xlsx,.xls" required />
            </div>
            <div class="selected-file" id="selectedFile">
                <i class="bi bi-file-earmark-check"></i>
                <span id="fileName"></span>
                <button type="button" class="btn-remove-file" onclick="clearFile()">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            <span asp-validation-for="ExcelFile" class="validation-error"></span>
            <small class="form-hint">Make sure you filled the correct tab in the Excel template</small>
        </div>

        <button type="submit" class="btn-submit" id="submitBtn">
            <i class="bi bi-cloud-upload"></i>
            Upload & Process
        </button>
    </div>

    @if (!ViewData.ModelState.IsValid)
    {
        <div class="alert-modern danger">
            <i class="bi bi-exclamation-triangle"></i>
            <strong>Please fix the following errors:</strong>
            <div asp-validation-summary="All" class="validation-summary"></div>
        </div>
    }
</form>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validation-unobtrusive/4.0.0/jquery.validate.unobtrusive.min.js"></script>

    <script>
        // Elements
        const fileInput = document.getElementById('ExcelFile');
        const fileUploadArea = document.getElementById('fileUploadArea');
        const selectedFile = document.getElementById('selectedFile');
        const fileName = document.getElementById('fileName');
        const submitBtn = document.getElementById('submitBtn');
        const uploadForm = document.getElementById('uploadForm');
        const systemType = document.getElementById('SystemType');

        // File input change handler
        fileInput.addEventListener('change', function(e) {
            handleFileSelection(this.files);
        });

        // Drag and drop handlers
        fileUploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('dragover');
        });

        fileUploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');
        });

        fileUploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');
            handleFileSelection(e.dataTransfer.files);
        });

        // File selection handler
        function handleFileSelection(files) {
            if (files.length > 0) {
                const file = files[0];

                // Validate file type
                if (!file.name.match(/\.(xlsx|xls)$/i)) {
                    showError('Invalid file type', 'Please select an Excel file (.xlsx or .xls)');
                    return;
                }

                // Validate file size (5MB max)
                if (file.size > 5 * 1024 * 1024) {
                    showError('File too large', 'Maximum file size is 5MB');
                    return;
                }

                fileName.textContent = file.name;
                selectedFile.classList.add('show');
            }
        }

        // Clear file selection
        function clearFile() {
            fileInput.value = '';
            selectedFile.classList.remove('show');
        }

        // Show error message
        function showError(title, text) {
            Swal.fire({
                icon: 'error',
                title: title,
                text: text,
                confirmButtonColor: '#3b82f6'
            });
            clearFile();
        }

        // Form submission handler
        uploadForm.addEventListener('submit', function(e) {
            const selectedSystem = systemType.value;
            const file = fileInput.files[0];

            // Validate system selection
            if (!selectedSystem) {
                e.preventDefault();
                showError('System Type Required', 'Please select a system type (InvoiceQ or Ocity)');
                return;
            }

            // Validate file selection
            if (!file) {
                e.preventDefault();
                showError('No File Selected', 'Please select an Excel file to upload');
                return;
            }

            // Disable submit button and show loading
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Processing...';

            // Show loading alert
            Swal.fire({
                title: 'Processing...',
                text: 'Uploading and processing your file',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
        });

        // Re-enable button if validation fails
        document.addEventListener('click', function() {
            if (submitBtn.disabled) {
                const form = document.getElementById('uploadForm');
                if (!form.checkValidity()) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="bi bi-cloud-upload"></i> Upload & Process';
                }
            }
        });

        // Click file upload area to trigger file input
               fileUploadArea.addEventListener('click', function(e) {
            if (e.target === fileUploadArea) {
                fileInput.click();
            }
        });
    </script>
}